openapi: '3.0.4'
info:
  title: Web Memo API
  version: '1.0'

security:
  - bearerAuth: []
  - cookieAuth: []

tags:
  - name: Auth
  - name: Memo
  - name: Tag
  - name: Subscription
  - name: Collaboration
  - name: Image

paths:
  ###
  # Auth
  ###
  /api/v1/google/sign-in:
    get:
      operationId: startGoogleSignIn
      summary: Start Google Sign-In
      security: []
      tags:
        - Auth
      responses:
        '302':
          description: Redirecting to Google Sign-In
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/google/sign-in/finish:
    get:
      operationId: finishGoogleSignIn
      summary: Finish Google Sign-In
      security: []
      tags:
        - Auth
      parameters:
        - name: code
          in: query
          required: true
          description: The authorization code returned by Google after sign-in.
          schema:
            type: string
        - name: state
          in: query
          required: true
          description: The state parameter to prevent CSRF attacks.
          schema:
            type: string
      responses:
        '302':
          description: Successfully signed in with Google
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/users/me:
    get:
      operationId: getCurrentUser
      summary: Get current user details
      tags:
        - Auth
      responses:
        '200':
          description: Successfully retrieved current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/users/refresh-token:
    post:
      operationId: refreshToken
      summary: Refresh the authentication token
      tags:
        - Auth
      responses:
        '200':
          description: Successfully refreshed token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/users/sign-out:
    get:
      operationId: signOut
      summary: Sign out the current user
      tags:
        - Auth
      responses:
        '200':
          description: Successfully signed out
        default:
          $ref: '#/components/responses/ErrorResponse'

  ###
  # Memo
  ###
  /api/v1/memos:
    get:
      operationId: listMemos
      summary: List memos
      tags:
        - Memo
      parameters:
        - $ref: '#/components/parameters/SearchQuery'
        - $ref: '#/components/parameters/PageQuery'
        - $ref: '#/components/parameters/PageSizeQuery'
        - $ref: '#/components/parameters/TagQuery'
        - $ref: '#/components/parameters/SortQuery'
      responses:
        '200':
          description: Successfully retrieved memos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMemosResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

    post:
      operationId: createMemo
      summary: Create a new memo
      tags:
        - Memo
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMemoRequest'
      responses:
        '200':
          description: Successfully created memo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Memo'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/memos/{memoId}:
    get:
      operationId: getMemo
      summary: Get memo details
      tags:
        - Memo
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      responses:
        '200':
          description: Successfully retrieved memo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Memo'
        default:
          $ref: '#/components/responses/ErrorResponse'

    put:
      operationId: replaceMemo
      summary: Replace a memo
      tags:
        - Memo
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/PinUpdateTimeQuery'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplaceMemoRequest'
      responses:
        '200':
          description: Successfully replaced memo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Memo'
        default:
          $ref: '#/components/responses/ErrorResponse'

    delete:
      operationId: deleteMemo
      summary: Delete a memo
      tags:
        - Memo
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      responses:
        '200':
          description: Successfully deleted memo
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/memos/{memoId}/publish:
    post:
      operationId: publishMemo
      summary: Publish or unpublish a memo
      tags:
        - Memo
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublishMemoRequest'
      responses:
        '200':
          description: Successfully updated publish state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Memo'
        default:
          $ref: '#/components/responses/ErrorResponse'

  ###
  # Tag
  ###
  /api/v1/memos/{memoId}/tags:
    get:
      operationId: getMemoTags
      summary: Get tags of a memo
      tags:
        - Tag
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      responses:
        '200':
          description: Successfully retrieved memo tags
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
        default:
          $ref: '#/components/responses/ErrorResponse'

    put:
      operationId: replaceMemoTags
      summary: Replace tags of a memo
      tags:
        - Tag
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                type: string
      responses:
        '200':
          description: Successfully replaced memo tags
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
        default:
          $ref: '#/components/responses/ErrorResponse'

  ###
  # Subscription
  ###
  /api/v1/memos/{memoId}/subscribers:
    get:
      operationId: listSubscribers
      summary: List subscribers of a memo
      tags:
        - Subscription
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      responses:
        '200':
          description: Successfully retrieved subscribers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListSubscribersResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/memos/{memoId}/subscribers/{userId}:
    get:
      operationId: getSubscriber
      summary: Get subscriber details
      tags:
        - Subscription
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: Successfully retrieved subscriber
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscriber'
        default:
          $ref: '#/components/responses/ErrorResponse'

    put:
      operationId: subscribe
      summary: Subscribe to a memo
      tags:
        - Subscription
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: Successfully subscribed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscribeResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

    delete:
      operationId: unsubscribe
      summary: Unsubscribe from a memo
      tags:
        - Subscription
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: Successfully unsubscribed
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/memos/{memoId}/subscribers/{userId}/authorize:
    post:
      operationId: authorizeSubscription
      summary: Approve or reject a subscription request
      tags:
        - Subscription
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthorizeSubscriptionRequest'
      responses:
        '200':
          description: Successfully authorized subscription
        default:
          $ref: '#/components/responses/ErrorResponse'

  ###
  # Collaboration
  ###
  /api/v1/memos/{memoId}/collaborators:
    get:
      operationId: listCollaborators
      summary: List collaborators of a memo
      tags:
        - Collaboration
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
      responses:
        '200':
          description: Successfully retrieved collaborators
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListCollaboratorsResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/memos/{memoId}/collaborators/{userId}:
    get:
      operationId: getCollaborator
      summary: Get collaborator details
      tags:
        - Collaboration
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: Successfully retrieved collaborator
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collaborator'
        default:
          $ref: '#/components/responses/ErrorResponse'

    put:
      operationId: requestCollaboration
      summary: Request collaboration on a memo
      tags:
        - Collaboration
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: Successfully requested collaboration
        default:
          $ref: '#/components/responses/ErrorResponse'

    delete:
      operationId: cancelCollaboration
      summary: Cancel collaboration on a memo
      tags:
        - Collaboration
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: Successfully cancelled collaboration
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/memos/{memoId}/collaborators/{userId}/authorize:
    post:
      operationId: authorizeCollaboration
      summary: Authorize or reject a collaboration request
      tags:
        - Collaboration
      parameters:
        - $ref: '#/components/parameters/MemoIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthorizeCollaborationRequest'
      responses:
        '200':
          description: Successfully authorized collaboration
        default:
          $ref: '#/components/responses/ErrorResponse'

  ###
  # Tag
  ###
  /api/v1/tags:
    get:
      operationId: searchTags
      summary: Search tags by keyword
      tags:
        - Tag
      parameters:
        - $ref: '#/components/parameters/KeywordQuery'
      responses:
        '200':
          description: Successfully retrieved tags
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
        default:
          $ref: '#/components/responses/ErrorResponse'

  ###
  # Image
  ###
  /api/v1/images/upload-url:
    post:
      operationId: createUploadURL
      summary: Create a presigned URL for uploading an image
      tags:
        - Image
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUploadURLRequest'
      responses:
        '200':
          description: Successfully created upload URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateUploadURLResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'

  /api/v1/images/{imageId}/status:
    get:
      operationId: getImageStatus
      summary: Get image processing status
      tags:
        - Image
      parameters:
        - $ref: '#/components/parameters/ImageIdPath'
        - $ref: '#/components/parameters/WaitUntilProcessedQuery'
      responses:
        '200':
          description: Successfully retrieved image status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageStatus'
        default:
          $ref: '#/components/responses/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    cookieAuth:
      type: apiKey
      in: cookie
      name: wmToken

  parameters:
    ###
    # Path Parameters
    ###
    MemoIdPath:
      name: memoId
      in: path
      required: true
      description: The ID of the memo.
      schema:
        type: string
        format: uuid

    UserIdPath:
      name: userId
      in: path
      required: true
      description: The ID of the user.
      schema:
        type: string
        format: uuid

    ImageIdPath:
      name: imageId
      in: path
      required: true
      description: The ID of the image.
      schema:
        type: string

    ###
    # Query Parameters
    ###
    PageQuery:
      name: page
      in: query
      description: Page number for pagination
      schema:
        type: integer
        default: 1
        minimum: 1

    PageSizeQuery:
      name: pageSize
      in: query
      description: Number of items per page
      schema:
        type: integer
        default: 10
        minimum: 1
        maximum: 100

    TagQuery:
      name: tag
      in: query
      description: Filter by tags
      style: form
      explode: true
      schema:
        type: array
        items:
          type: string
        x-go-type-skip-optional-pointer: true

    SortQuery:
      name: sort
      in: query
      description: Sort key for listing memos
      schema:
        $ref: '#/components/schemas/MemoSortKey'

    SearchQuery:
      name: q
      in: query
      description: Search query string
      schema:
        type: string

    PinUpdateTimeQuery:
      name: pinUpdateTime
      in: query
      description: Whether to keep the current update time
      schema:
        type: boolean
        default: false

    WaitUntilProcessedQuery:
      name: waitUntilProcessed
      in: query
      description: Wait until the image processing is completed
      schema:
        type: boolean
        default: false

    KeywordQuery:
      name: kw
      in: query
      description: Keyword for searching tags
      schema:
        type: string

  responses:
    ###
    # Error Responses
    ###
    ErrorResponse:
      description: Error occurred during the request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    ###
    # Enums
    ###
    MemoSortKey:
      type: string
      enum:
        - createTime
        - updateTime
      example: updateTime
      x-go-type: enum.MemoSortKey
      x-go-import:
        path: github.com/isutare412/web-memo/api/internal/core/enum

    PublishState:
      type: string
      enum:
        - private
        - shared
        - published
      example: private
      x-go-type: enum.PublishState
      x-go-import:
        path: github.com/isutare412/web-memo/api/internal/core/enum

    ImageFormat:
      type: string
      example: PNG
      x-go-type: images.Format
      x-go-import:
        path: github.com/isutare412/imageer/pkg/images

    ImageState:
      type: string
      example: READY
      x-go-type: images.State
      x-go-import:
        path: github.com/isutare412/imageer/pkg/images

    ###
    # Error Schemas
    ###
    ErrorResponse:
      type: object
      properties:
        msg:
          type: string
      required:
        - msg
      example:
        msg: memo not found

    ###
    # Auth Schemas
    ###
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userType:
          type: string
        email:
          type: string
        userName:
          type: string
        givenName:
          type: string
        familyName:
          type: string
        photoUrl:
          type: string
        issuedAt:
          type: string
          format: date-time
        expireAt:
          type: string
          format: date-time
      required:
        - id
        - userType
        - email
        - userName
        - issuedAt
        - expireAt
      example:
        id: 550e8400-e29b-41d4-a716-446655440000
        userType: google
        email: john.doe@example.com
        userName: John Doe
        givenName: John
        familyName: Doe
        photoUrl: https://example.com/photos/john.jpg
        issuedAt: '2025-01-15T09:00:00Z'
        expireAt: '2025-01-15T10:00:00Z'

    ###
    # Memo Schemas
    ###
    Memo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        ownerId:
          type: string
          format: uuid
        createTime:
          type: string
          format: date-time
        updateTime:
          type: string
          format: date-time
        title:
          type: string
        content:
          type: string
        publishState:
          $ref: '#/components/schemas/PublishState'
        version:
          type: integer
        tags:
          type: array
          items:
            type: string
        scores:
          $ref: '#/components/schemas/MemoScores'
        viewerContext:
          $ref: '#/components/schemas/MemoViewerContext'
      required:
        - id
        - ownerId
        - createTime
        - updateTime
        - title
        - content
        - publishState
        - version
        - tags
      example:
        id: 7c9a1e50-e29b-41d4-a716-446655440001
        ownerId: 550e8400-e29b-41d4-a716-446655440000
        createTime: '2025-01-15T09:30:00Z'
        updateTime: '2025-01-15T10:00:00Z'
        title: Meeting Notes
        content: Discussed project roadmap and Q2 goals.
        publishState: private
        version: 3
        tags:
          - work
          - meeting
        scores:
          rrf: 0.85
          semantic: 0.92
          bm25: 0.78
        viewerContext:
          subscription:
            isApproved: true
          collaboration:
            isApproved: false

    MemoScores:
      type: object
      properties:
        rrf:
          type: number
          format: float
        semantic:
          type: number
          format: float
        bm25:
          type: number
          format: float
      required:
        - rrf
        - semantic
        - bm25
      example:
        rrf: 0.85
        semantic: 0.92
        bm25: 0.78

    CreateMemoRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
        content:
          type: string
          maxLength: 12000
        tags:
          type: array
          items:
            type: string
          x-go-type-skip-optional-pointer: true
      required:
        - title
      example:
        title: Shopping List
        content: 'Eggs, milk, bread, butter'
        tags:
          - personal
          - groceries

    ReplaceMemoRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
        content:
          type: string
          maxLength: 12000
        tags:
          type: array
          items:
            type: string
          x-go-type-skip-optional-pointer: true
        version:
          type: integer
      required:
        - title
        - version
      example:
        title: Shopping List (Updated)
        content: 'Eggs, milk, bread, butter, cheese'
        tags:
          - personal
          - groceries
        version: 2

    PublishMemoRequest:
      type: object
      properties:
        publishState:
          $ref: '#/components/schemas/PublishState'
      required:
        - publishState
      example:
        publishState: published

    ListMemosResponse:
      type: object
      properties:
        page:
          type: integer
          nullable: true
        pageSize:
          type: integer
          nullable: true
        lastPage:
          type: integer
          nullable: true
        totalMemoCount:
          type: integer
          nullable: true
        memos:
          type: array
          items:
            $ref: '#/components/schemas/Memo'
      required:
        - memos
      example:
        page: 1
        pageSize: 10
        lastPage: 5
        totalMemoCount: 42
        memos:
          - id: 7c9a1e50-e29b-41d4-a716-446655440001
            ownerId: 550e8400-e29b-41d4-a716-446655440000
            createTime: '2025-01-15T09:30:00Z'
            updateTime: '2025-01-15T10:00:00Z'
            title: Meeting Notes
            content: Discussed project roadmap and Q2 goals.
            publishState: private
            version: 3
            tags:
              - work
              - meeting

    ###
    # Subscriber Schemas
    ###
    Subscriber:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userName:
          type: string
        photoUrl:
          type: string
        approved:
          type: boolean
      required:
        - id
        - userName
        - photoUrl
        - approved
      example:
        id: 8f14e45f-ceea-467f-a83c-0a06b8578e4a
        userName: Jane Smith
        photoUrl: https://example.com/photos/jane.jpg
        approved: true

    ListSubscribersResponse:
      type: object
      properties:
        memoOwnerId:
          type: string
          format: uuid
        subscribers:
          type: array
          items:
            $ref: '#/components/schemas/Subscriber'
      required:
        - memoOwnerId
        - subscribers
      example:
        memoOwnerId: 550e8400-e29b-41d4-a716-446655440000
        subscribers:
          - id: 8f14e45f-ceea-467f-a83c-0a06b8578e4a
            userName: Jane Smith
            photoUrl: https://example.com/photos/jane.jpg
            approved: true

    SubscribeResponse:
      type: object
      properties:
        subscription:
          type: object
          properties:
            userId:
              type: string
              format: uuid
            memoId:
              type: string
              format: uuid
            approved:
              type: boolean
          required:
            - userId
            - memoId
            - approved
      required:
        - subscription
      example:
        subscription:
          userId: 550e8400-e29b-41d4-a716-446655440000
          memoId: 7c9a1e50-e29b-41d4-a716-446655440001
          approved: true

    AuthorizeSubscriptionRequest:
      type: object
      properties:
        approve:
          type: boolean
      required:
        - approve
      example:
        approve: true

    ###
    # Collaborator Schemas
    ###
    Collaborator:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userName:
          type: string
        photoUrl:
          type: string
        isApproved:
          type: boolean
      required:
        - id
        - userName
        - photoUrl
        - isApproved
      example:
        id: 8f14e45f-ceea-467f-a83c-0a06b8578e4a
        userName: Jane Smith
        photoUrl: https://example.com/photos/jane.jpg
        isApproved: true

    ListCollaboratorsResponse:
      type: object
      properties:
        memoOwnerId:
          type: string
          format: uuid
        collaborators:
          type: array
          items:
            $ref: '#/components/schemas/Collaborator'
      required:
        - memoOwnerId
        - collaborators
      example:
        memoOwnerId: 550e8400-e29b-41d4-a716-446655440000
        collaborators:
          - id: 8f14e45f-ceea-467f-a83c-0a06b8578e4a
            userName: Jane Smith
            photoUrl: https://example.com/photos/jane.jpg
            isApproved: true

    ViewerCollaboration:
      type: object
      properties:
        isApproved:
          type: boolean
      required:
        - isApproved
      example:
        isApproved: true

    MemoViewerContext:
      type: object
      properties:
        subscription:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/ViewerSubscription'
        collaboration:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/ViewerCollaboration'
      required:
        - subscription
        - collaboration
      example:
        subscription:
          isApproved: true
        collaboration:
          isApproved: false

    ViewerSubscription:
      type: object
      properties:
        isApproved:
          type: boolean
      required:
        - isApproved
      example:
        isApproved: true

    AuthorizeCollaborationRequest:
      type: object
      properties:
        approve:
          type: boolean
      required:
        - approve
      example:
        approve: true

    ###
    # Image Schemas
    ###
    CreateUploadURLRequest:
      type: object
      properties:
        fileName:
          type: string
        format:
          $ref: '#/components/schemas/ImageFormat'
      required:
        - fileName
        - format
      example:
        fileName: photo.png
        format: PNG

    CreateUploadURLResponse:
      type: object
      properties:
        imageId:
          type: string
        uploadUrl:
          type: string
        uploadHeaders:
          type: object
          additionalProperties:
            type: string
        expiresAt:
          type: string
          format: date-time
      required:
        - imageId
        - uploadUrl
        - uploadHeaders
        - expiresAt
      example:
        imageId: img_abc123
        uploadUrl: https://storage.example.com/upload/img_abc123
        uploadHeaders:
          Content-Type: image/png
        expiresAt: '2025-01-15T10:30:00Z'

    ImageStatus:
      type: object
      properties:
        id:
          type: string
        state:
          $ref: '#/components/schemas/ImageState'
        original:
          nullable: true
          $ref: '#/components/schemas/ImageVariant'
        downscaled:
          nullable: true
          $ref: '#/components/schemas/ImageVariant'
      required:
        - id
        - state
      example:
        id: img_abc123
        state: READY
        original:
          url: https://storage.example.com/images/img_abc123/original.png
          format: PNG
        downscaled:
          url: https://storage.example.com/images/img_abc123/downscaled.webp
          format: WEBP

    ImageVariant:
      type: object
      properties:
        url:
          type: string
        format:
          $ref: '#/components/schemas/ImageFormat'
      required:
        - url
        - format
      example:
        url: https://storage.example.com/images/img_abc123/original.png
        format: PNG
